<!DOCTYPE html>
<html lang="en">
  <head>
    <title>commanderX</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <div id="app">
      <h1 align="center"><a href="/">commanderX</a></h1>
      <div id="input">
        <a href="/">$</a> <input name="cmd" placeholder="$ " autofocus="autofocus" onfocus="this.select()"> <button onclick="command()">Execute</button>
      </div>
      <pre><code></code></pre>
    </div>
    <script>
last_cmd = ''; last_pid = 0; ctrl_c_pressed = 0;
input.addEventListener("keydown", function(event) {
  if (event.keyCode === 13) {
    event.preventDefault();
    command();
  } else if (event.keyCode === 38) {
    event.preventDefault();
    document.querySelector('input').value = last_cmd;
  } else if (event.ctrlKey && event.keyCode === 67) {
    ctrl_c_pressed++;
    killer_socket.send(`SIGINT:${last_pid}`);
    if (ctrl_c_pressed >= 7) {
      killer_socket.send(`SIGKILL:${last_pid}`);
      ctrl_c_pressed = 0;
    }
  }
});
      const execute = (cmd) => {
        document.querySelector('code').innerText += `$ ${cmd}\n`;
        socket.send(cmd);
        last_cmd = cmd;
      }; const command = () => {
        cmd = document.querySelector('input').value;
        execute(cmd);
        document.querySelector('input').value = '';
        document.querySelector('code').innerText += '\n---------------------\n\n';
      }

      const socket = new WebSocket(`ws://localhost:${Number(document.location.port) + 1}`);
      const killer_socket = new WebSocket(`ws://localhost:${Number(document.location.port) + 1}`);

      socket.addEventListener('open', function (event) {
          // socket.send('ping -c 8 1.1');
          document.querySelector('code').innerText += '[+] Connected!\n\n';
      });

      socket.addEventListener('message', function (event) {
          data = event.data;
          if (data) {
            // data.text().then( txt => {
            txt = data;
              if (txt.startsWith('!PID:')) {
                last_pid = Number(txt.slice(5));
                document.querySelector('code').innerText += `(PID: ${last_pid})\n`;
              } else {
                document.querySelector('code').innerText += txt;
                window.scrollTo(0, 9999);
              };
            // });
          }
      });
    </script>
  </body>
</html>
